// State Management
let state = {
  products: [],
  orders: [],
  currentProduct: null,
  cart: [],
  adminMode: false
};

// DOM Elements
const elements = {
  notification: document.getElementById('notification'),
  productsGrid: document.getElementById('products-grid'),
  adminPanel: document.getElementById('admin-panel'),
  customizerModal: document.getElementById('customizer-modal'),
  importModal: document.getElementById('import-modal'),
  adminProductsList: document.getElementById('admin-products-list'),
  // ... add other element references as needed
};

// Initialize the application
function init() {
  loadSampleData();
  renderProducts();
  setupEventListeners();
  updateStats();
}

// Load sample data
function loadSampleData() {
  const sampleProducts = [
    {
      id: 'p1',
      title: 'Articulated Dinosaur',
      price: 1200,
      description: 'Fully articulated 3D printed dinosaur with movable joints',
      category: 'custom-items',
      image: '',
      state: 'active'
    },
    {
      id: 'p2',
      title: 'Phone Stand',
      price: 450,
      description: 'Elegant phone stand with cable management',
      category: 'phone-stands',
      image: '',
      state: 'active'
    },
    {
      id: 'p3',
      title: 'Custom Keychain',
      price: 300,
      description: 'Personalized keychain with text engraving',
      category: 'accessories',
      image: '',
      state: 'active'
    },
    {
      id: 'p4',
      title: 'Planter Pot',
      price: 650,
      description: 'Geometric plant pot with drainage',
      category: 'home-decor',
      image: '',
      state: 'active'
    }
  ];

  // Load from localStorage or use sample data
  const savedProducts = localStorage.getItem('xustom3d-products');
  state.products = savedProducts ? JSON.parse(savedProducts) : sampleProducts;
  
  // Save initial data if not present
  if (!savedProducts) {
    localStorage.setItem('xustom3d-products', JSON.stringify(sampleProducts));
  }
}

// Render products to the shop grid
function renderProducts() {
  const activeProducts = state.products.filter(p => p.state === 'active');
  
  elements.productsGrid.innerHTML = activeProducts.map(product => `
    <div class="card">
      <div class="product-img">
        ${product.image ? 
          `<img src="${product.image}" alt="${product.title}">` : 
          `<i class="fas fa-cube fa-3x" style="color:#7c3aed"></i>`
        }
      </div>
      <h3>${product.title}</h3>
      <p class="small">${product.description}</p>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px">
        <div style="font-weight:700;color:var(--primary)">₨ ${product.price}</div>
        <button class="cta" onclick="openCustomizer('${product.id}')">
          <i class="fas fa-palette"></i>
          Customize
        </button>
      </div>
    </div>
  `).join('');
}

// Setup all event listeners
function setupEventListeners() {
  // Admin panel toggle
  document.getElementById('open-admin-panel').addEventListener('click', () => {
    elements.adminPanel.classList.add('visible');
  });
  
  document.getElementById('close-admin').addEventListener('click', () => {
    elements.adminPanel.classList.remove('visible');
  });
  
  // Customizer modal
  document.getElementById('open-customize').addEventListener('click', () => {
    openCustomizer('p1');
  });
  
  document.getElementById('close-customizer').addEventListener('click', () => {
    elements.customizerModal.classList.remove('visible');
  });
  
  // Product management
  document.getElementById('add-product-btn').addEventListener('click', addOrUpdateProduct);
  
  // Import/Export
  document.getElementById('export-products').addEventListener('click', exportProducts);
  document.getElementById('import-products').addEventListener('click', () => {
    elements.importModal.classList.add('visible');
  });
  
  document.getElementById('run-import').addEventListener('click', importProducts);
  document.getElementById('cancel-import').addEventListener('click', () => {
    elements.importModal.classList.remove('visible');
  });
  
  // Contact form
  document.getElementById('send-contact').addEventListener('click', sendContactMessage);
  
  // Navigation
  document.querySelectorAll('[data-route]').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const route = e.target.getAttribute('href').substring(1);
      navigateTo(route);
    });
  });
}

// Navigation function
function navigateTo(route) {
  // Update active nav link
  document.querySelectorAll('[data-route]').forEach(link => {
    link.classList.remove('active');
    if (link.getAttribute('href') === `#${route}`) {
      link.classList.add('active');
    }
  });
  
  // Scroll to section
  const section = document.getElementById(`${route}-section`);
  if (section) {
    section.scrollIntoView({ behavior: 'smooth' });
  }
}

// Open product customizer
function openCustomizer(productId) {
  const product = state.products.find(p => p.id === productId);
  if (!product) return;
  
  state.currentProduct = product;
  
  // Update customizer UI
  document.getElementById('customizer-title').textContent = `Customize ${product.title}`;
  document.getElementById('customizer-price').textContent = `₨ ${product.price}`;
  
  // Generate color palette
  const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#000000', '#ffffff'];
  const colorPalette = document.getElementById('color-palette');
  colorPalette.innerHTML = colors.map(color => `
    <div class="color-swatch ${color === '#3b82f6' ? 'selected' : ''}" 
         style="background-color:${color}" 
         onclick="selectColor(this, '${color}')"></div>
  `).join('');
  
  // Show modal
  elements.customizerModal.classList.add('visible');
}

// Select color in customizer
function selectColor(element, color) {
  document.querySelectorAll('.color-swatch').forEach(swatch => {
    swatch.classList.remove('selected');
  });
  element.classList.add('selected');
  
  // Update preview (simplified)
  const preview = document.getElementById('customizer-preview');
  preview.style.background = `linear-gradient(135deg, ${color}20, ${color}40)`;
  preview.innerHTML = `
    <div style="text-align:center;color:var(--muted)">
      <i class="fas fa-cube" style="font-size:3rem;margin-bottom:16px;color:${color}"></i>
      <div>${state.currentProduct.title}</div>
      <div class="small" style="margin-top:8px">Color: ${color}</div>
    </div>
  `;
}

// Add or update product in admin
function addOrUpdateProduct() {
  const title = document.getElementById('product-title').value;
  const price = parseInt(document.getElementById('product-price').value);
  const image = document.getElementById('product-image').value;
  const description = document.getElementById('product-description').value;
  const category = document.getElementById('product-category').value;
  const productState = document.getElementById('product-state').value;
  
  if (!title || !price || !category) {
    showNotification('Please fill all required fields', 'error');
    return;
  }
  
  const newProduct = {
    id: `p${Date.now()}`,
    title,
    price,
    image,
    description,
    category,
    state: productState
  };
  
  state.products.push(newProduct);
  saveProducts();
  renderProducts();
  renderAdminProducts();
  updateStats();
  
  // Clear form
  document.getElementById('product-title').value = '';
  document.getElementById('product-price').value = '';
  document.getElementById('product-image').value = '';
  document.getElementById('product-description').value = '';
  
  showNotification('Product added successfully!', 'success');
}

// Render products in admin panel
function renderAdminProducts() {
  elements.adminProductsList.innerHTML = state.products.map(product => `
    <div class="card" style="margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div style="flex:1">
          <h3 style="margin-bottom:8px">${product.title}</h3>
          <div class="small" style="margin-bottom:8px">${product.description}</div>
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <span class="small" style="background:#f1f5f9;padding:4px 8px;border-radius:6px">
              <i class="fas fa-tag"></i> ${product.category}
            </span>
            <span class="small" style="background:#f1f5f9;padding:4px 8px;border-radius:6px">
              <i class="fas fa-money-bill"></i> ₨ ${product.price}
            </span>
            <span class="small" style="background:#f1f5f9;padding:4px 8px;border-radius:6px">
              <i class="fas fa-circle" style="color:${
                product.state === 'active' ? '#10b981' : 
                product.state === 'draft' ? '#f59e0b' : '#6b7280'
              }"></i> ${product.state}
            </span>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="admin-btn" onclick="editProduct('${product.id}')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="admin-btn danger" onclick="deleteProduct('${product.id}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

// Edit product
function editProduct(productId) {
  const product = state.products.find(p => p.id === productId);
  if (!product) return;
  
  document.getElementById('product-title').value = product.title;
  document.getElementById('product-price').value = product.price;
  document.getElementById('product-image').value = product.image;
  document.getElementById('product-description').value = product.description;
  document.getElementById('product-category').value = product.category;
  document.getElementById('product-state').value = product.state;
  
  // Scroll to form
  document.getElementById('product-title').scrollIntoView({ behavior: 'smooth' });
}

// Delete product
function deleteProduct(productId) {
  if (confirm('Are you sure you want to delete this product?')) {
    state.products = state.products.filter(p => p.id !== productId);
    saveProducts();
    renderProducts();
    renderAdminProducts();
    updateStats();
    showNotification('Product deleted', 'success');
  }
}

// Export products to CSV
function exportProducts() {
  const csvContent = "data:text/csv;charset=utf-8," 
    + "id,title,price,description,category,image_url,state\n"
    + state.products.map(p => 
        `"${p.id}","${p.title}",${p.price},"${p.description}","${p.category}","${p.image}","${p.state}"`
      ).join("\n");
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "xustom3d_products.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showNotification('Products exported successfully', 'success');
}

// Import products from CSV
function importProducts() {
  const csvData = document.getElementById('import-area').value;
  if (!csvData) {
    showNotification('Please paste CSV data', 'error');
    return;
  }
  
  try {
    const lines = csvData.split('\n');
    const headers = lines[0].split(',');
    
    // Skip header row and process data
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(',');
      if (values.length === headers.length) {
        const product = {
          id: values[0].replace(/"/g, ''),
          title: values[1].replace(/"/g, ''),
          price: parseInt(values[2]),
          description: values[3].replace(/"/g, ''),
          category: values[4].replace(/"/g, ''),
          image: values[5].replace(/"/g, ''),
          state: values[6].replace(/"/g, '') || 'active'
        };
        
        // Check if product already exists
        const existingIndex = state.products.findIndex(p => p.id === product.id);
        if (existingIndex >= 0) {
          state.products[existingIndex] = product;
        } else {
          state.products.push(product);
        }
      }
    }
    
    saveProducts();
    renderProducts();
    renderAdminProducts();
    updateStats();
    elements.importModal.classList.remove('visible');
    document.getElementById('import-area').value = '';
    
    showNotification('Products imported successfully', 'success');
  } catch (error) {
    showNotification('Error importing CSV data', 'error');
    console.error(error);
  }
}

// Update admin statistics
function updateStats() {
  document.getElementById('stats-products').textContent = state.products.length;
  document.getElementById('stats-orders').textContent = state.orders.length;
  document.getElementById('admin-stats').textContent = `${state.products.length} products total`;
}

// Save products to localStorage
function saveProducts() {
  localStorage.setItem('xustom3d-products', JSON.stringify(state.products));
}

// Show notification
function showNotification(message, type = 'info') {
  const notification = elements.notification;
  notification.textContent = message;
  notification.className = `notification ${type} show`;
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// Send contact message
function sendContactMessage() {
  const name = document.getElementById('contact-name').value;
  const email = document.getElementById('contact-email').value;
  const phone = document.getElementById('contact-phone').value;
  const message = document.getElementById('contact-message').value;
  
  if (!name || !email || !message) {
    showNotification('Please fill all required fields', 'error');
    return;
  }
  
  // Simulate sending message
  showNotification('Message sent successfully! We will get back to you soon.', 'success');
  
  // Clear form
  document.getElementById('contact-name').value = '';
  document.getElementById('contact-email').value = '';
  document.getElementById('contact-phone').value = '';
  document.getElementById('contact-message').value = '';
}

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', init);
